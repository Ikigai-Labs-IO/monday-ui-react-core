name: Release new version

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-node@v3
        with:
          node-version: '14'
          registry-url: https://registry.npmjs.org/

      - name: Install dependencies
        run: npm ci

      - name: Check if version is published
        id: check-version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view your-package-name@$PACKAGE_VERSION > /dev/null 2>&1; then
            echo "Version $PACKAGE_VERSION already published. Skipping publishing step."
            echo "::set-output name=skip_publishing::true"
          else
            echo "Version $PACKAGE_VERSION not published. Proceeding with publishing."
            echo "::set-output name=skip_publishing::false"
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TEST_VIBE }}

      - name: Run semantic-release
        if: steps.check-version.outputs.skip_publishing == 'false'
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TEST_VIBE }}
